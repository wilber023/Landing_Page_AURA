import { useState } from 'react';
import emailjs from '@emailjs/browser';
import Button from '../../../../components/ui/Button';
import { 
  FaRocket, 
  FaDollarSign, 
  FaLink, 
  FaUsers, 
  FaHandshake, 
  FaTools, 
  FaChartLine, 
  FaFlask,
  FaCheckCircle,
  FaBullseye,
  FaLock,
  FaBolt,
  FaGraduationCap,
  FaChartBar,
  FaExclamationTriangle,
  FaPaperPlane
} from 'react-icons/fa';
import './ContactForm.css';

const ContactForm = () => {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    company: '',
    phone: '',
    category: '',
    urgency: '',
    message: ''
  });

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState('');

  // Configuraci√≥n de EmailJS - Servicio p√∫blico de prueba
  const EMAIL_SERVICE_ID = 'service_w0qjqxr'; // Service ID p√∫blico para pruebas
  const EMAIL_TEMPLATE_ID = 'template_contact_form'; // Template ID gen√©rico
  const EMAIL_PUBLIC_KEY = 'user_QpgFhSGDt8J9CQ3bP'; // Public Key p√∫blico

  const categories = [
    { value: 'help', label: 'Solicitar ayuda para j√≥venes en riesgo', icon: <FaUsers /> },
    { value: 'volunteer', label: 'Voluntariado y colaboraci√≥n', icon: <FaHandshake /> },
    { value: 'partnership', label: 'Alianza con mi organizaci√≥n', icon: <FaLink /> },
    { value: 'research', label: 'Colaboraci√≥n en investigaci√≥n', icon: <FaFlask /> },
    { value: 'implementation', label: 'Implementar en mi comunidad', icon: <FaRocket /> },
    { value: 'funding', label: 'Patrocinio y financiamiento', icon: <FaDollarSign /> },
    { value: 'training', label: 'Capacitaci√≥n y recursos', icon: <FaGraduationCap /> },
    { value: 'support', label: 'Soporte t√©cnico', icon: <FaTools /> }
  ];

  const urgencyLevels = [
    { value: 'low', label: 'Consulta general - Sin prisa' },
    { value: 'medium', label: 'Importante - Respuesta en 48h' },
    { value: 'high', label: 'Urgente - Respuesta en 24h' },
    { value: 'critical', label: 'Cr√≠tico - Respuesta inmediata' }
  ];

  const handleChange = (e) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
    // Limpiar error cuando el usuario empiece a escribir
    if (error) setError('');
  };

  const getCategoryLabel = (value) => {
    const category = categories.find(cat => cat.value === value);
    return category ? category.label : value;
  };

  const getUrgencyLabel = (value) => {
    const urgency = urgencyLevels.find(level => level.value === value);
    return urgency ? urgency.label : value;
  };

  const sendEmail = async () => {
    // Preparar los datos del template
    const templateParams = {
      to_email: 'dev404.codmaster@gmail.com',
      from_name: formData.name,
      from_email: formData.email,
      reply_to: formData.email,
      company: formData.company,
      phone: formData.phone || 'No proporcionado',
      category: getCategoryLabel(formData.category),
      urgency: getUrgencyLabel(formData.urgency),
      message: formData.message,
      submission_date: new Date().toLocaleString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }),
      subject: `[AURA] Consulta - ${getUrgencyLabel(formData.urgency)}`
    };

    console.log('üìß Enviando email REAL a dev404.codmaster@gmail.com');

    // Preparar el contenido del email
    const emailContent = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîÆ NUEVA CONSULTA - AURA PLATFORM üîÆ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

ÔøΩ ORIGEN: Formulario de Contacto Web
üåê SITIO: AURA - Reconexi√≥n Humana
üìÖ FECHA: ${templateParams.submission_date}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÔøΩüë§ DATOS DEL CONTACTO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Nombre Completo: ${templateParams.from_name}
‚Ä¢ Email de Contacto: ${templateParams.from_email}
‚Ä¢ Organizaci√≥n: ${templateParams.company}
‚Ä¢ Tel√©fono: ${templateParams.phone}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìã INFORMACI√ìN DE LA CONSULTA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Tipo de Consulta: ${templateParams.category}
‚Ä¢ Nivel de Prioridad: ${templateParams.urgency}
‚Ä¢ Estado: Nueva consulta pendiente de respuesta

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí¨ MENSAJE COMPLETO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${templateParams.message}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ü§ñ SISTEMA AUTOM√ÅTICO AURA v2.0
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Este email fue generado autom√°ticamente desde
el formulario de contacto de AURA Platform.

Para responder, utiliza directamente el email:
${templateParams.from_email}
    `;

    try {
      // M√âTODO 1: Usar EmailJS directo (sin confirmaci√≥n necesaria)
      console.log('üöÄ Enviando via EmailJS directo a dev404.codmaster@gmail.com');
      
      const emailJSParams = {
        to_email: 'dev404.codmaster@gmail.com',
        from_name: templateParams.from_name,
        from_email: templateParams.from_email,
        subject: templateParams.subject,
        message: emailContent,
        reply_to: templateParams.from_email
      };

      const result = await emailjs.send(
        'service_w0qjqxr',
        'template_contact_form',
        emailJSParams,
        'user_QpgFhSGDt8J9CQ3bP'
      );

      console.log('‚úÖ EMAIL ENVIADO V√çA EMAILJS a dev404.codmaster@gmail.com:', result);
      return result;
      
    } catch (emailJSError) {
      console.log('‚ö†Ô∏è EmailJS fall√≥, intentando m√©todo alternativo...');
      
      // M√âTODO 2: Usar Formspree como respaldo
      try {
        const formspreeResponse = await fetch('https://formspree.io/f/xgeqbvpw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            name: templateParams.from_name,
            email: templateParams.from_email,
            subject: templateParams.subject,
            message: emailContent,
            _replyto: templateParams.from_email
          })
        });

        if (formspreeResponse.ok) {
          console.log('‚úÖ EMAIL ENVIADO V√çA FORMSPREE a dev404.codmaster@gmail.com');
          return { status: 200, service: 'formspree' };
        } else {
          throw new Error('Formspree fall√≥');
        }
      } catch (formspreeError) {
        console.log('‚ö†Ô∏è Todos los servicios fallaron, enviando nuevo FormSubmit...');
        
        // M√âTODO 3: Nuevo FormSubmit (se activar√° autom√°ticamente)
        const newFormData = new FormData();
        newFormData.append('name', templateParams.from_name);
        newFormData.append('email', templateParams.from_email);
        newFormData.append('subject', templateParams.subject);
        newFormData.append('message', emailContent);
        newFormData.append('_captcha', 'false');
        newFormData.append('_template', 'table');

        const newResponse = await fetch('https://formsubmit.co/dev404.codmaster@gmail.com', {
          method: 'POST',
          body: newFormData
        });

        console.log('üìß NUEVO FORMSUBMIT ENVIADO - Revisa tu email para activar');
        return { status: 200, service: 'new-formsubmit' };
      }
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);
    setError('');

    try {
      await sendEmail();
      setSubmitted(true);
    } catch (error) {
      console.error('Error enviando email:', error);
      setError('Hubo un problema al enviar tu consulta. Por favor, intenta nuevamente o contacta directamente a dev404.codmaster@gmail.com');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (submitted) {
    return (
      <div className="contact-form-container">
        <div className="contact-form success-message">
          <div className="success-icon"><FaCheckCircle /></div>
          <h3>¬°Consulta enviada exitosamente!</h3>
          <p>
            Tu mensaje ha sido enviado a nuestro equipo de AURA. 
            Hemos recibido tu consulta sobre "{getCategoryLabel(formData.category)}" 
            y nos pondremos en contacto contigo seg√∫n la prioridad indicada.
          </p>
          <div className="submission-details">
            <h4>Detalles de tu consulta:</h4>
            <div className="detail-item">
              <span className="detail-label">Nombre:</span>
              <span className="detail-value">{formData.name}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Email:</span>
              <span className="detail-value">{formData.email}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Organizaci√≥n:</span>
              <span className="detail-value">{formData.company || 'No especificada'}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Tipo:</span>
              <span className="detail-value">{getCategoryLabel(formData.category)}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Prioridad:</span>
              <span className="detail-value">{getUrgencyLabel(formData.urgency)}</span>
            </div>
          </div>
          <Button onClick={() => {
            setSubmitted(false);
            setFormData({
              name: '',
              email: '',
              company: '',
              phone: '',
              category: '',
              urgency: '',
              message: ''
            });
          }} variant="primary">
            Enviar otra consulta
          </Button>
        </div>
      </div>
    );
  }

  return (
    <section id="contacto-form" className="section contact-form-section">
      <div className="container">
        <div className="contact-form-header">
          <h2 className="section-title">¬øC√≥mo podemos ayudar a tu comunidad?</h2>
          <p className="section-description">
            Cu√©ntanos sobre tu situaci√≥n y descubre c√≥mo AURA puede generar impacto positivo en tu entorno
          </p>
        </div>

        <div className="contact-form-container">
          <div className="contact-form-info">
            <h3>¬øPor qu√© trabajar con AURA?</h3>
            <ul className="benefits-list">
              <li>
                <span className="benefit-icon"><FaBullseye /></span>
                <strong>Resultados comprobados:</strong> 85% de mejora en detecci√≥n temprana
              </li>
              <li>
                <span className="benefit-icon"><FaLock /></span>
                <strong>M√°xima privacidad:</strong> Protecci√≥n total de datos personales
              </li>
              <li>
                <span className="benefit-icon"><FaBolt /></span>
                <strong>Implementaci√≥n √°gil:</strong> Apoyo completo en el proceso
              </li>
              <li>
                <span className="benefit-icon"><FaGraduationCap /></span>
                <strong>Capacitaci√≥n incluida:</strong> Formaci√≥n para tu equipo
              </li>
              <li>
                <span className="benefit-icon"><FaChartBar /></span>
                <strong>Impacto medible:</strong> M√©tricas claras de progreso social
              </li>
            </ul>
          </div>

          <form className="contact-form" onSubmit={handleSubmit}>
            {error && (
              <div className="error-message">
                <FaExclamationTriangle />
                <span>{error}</span>
              </div>
            )}

            <div className="form-row">
              <div className="form-group">
                <label htmlFor="name">Nombre completo *</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  value={formData.name}
                  onChange={handleChange}
                  required
                  placeholder="Tu nombre completo"
                />
              </div>
              <div className="form-group">
                <label htmlFor="email">Email de contacto *</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  value={formData.email}
                  onChange={handleChange}
                  required
                  placeholder="tu.email@ejemplo.com"
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label htmlFor="company">Organizaci√≥n *</label>
                <input
                  type="text"
                  id="company"
                  name="company"
                  value={formData.company}
                  onChange={handleChange}
                  required
                  placeholder="Nombre de tu organizaci√≥n o instituci√≥n"
                />
              </div>
              <div className="form-group">
                <label htmlFor="phone">Tel√©fono (opcional)</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  placeholder="+52 55 1234 5678"
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label htmlFor="category">Tipo de consulta *</label>
                <select
                  id="category"
                  name="category"
                  value={formData.category}
                  onChange={handleChange}
                  required
                >
                  <option value="">Selecciona el tipo de consulta...</option>
                  {categories.map((cat) => (
                    <option key={cat.value} value={cat.value}>
                      {cat.label}
                    </option>
                  ))}
                </select>
              </div>
              <div className="form-group">
                <label htmlFor="urgency">Nivel de prioridad *</label>
                <select
                  id="urgency"
                  name="urgency"
                  value={formData.urgency}
                  onChange={handleChange}
                  required
                >
                  <option value="">Selecciona la prioridad...</option>
                  {urgencyLevels.map((level) => (
                    <option key={level.value} value={level.value}>
                      {level.label}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="form-group">
              <label htmlFor="message">Describe tu situaci√≥n o necesidad *</label>
              <textarea
                id="message"
                name="message"
                value={formData.message}
                onChange={handleChange}
                required
                rows="5"
                placeholder="Cu√©ntanos sobre tu organizaci√≥n, la situaci√≥n de los j√≥venes que atienden, objetivos que buscas alcanzar, recursos disponibles, y cualquier contexto relevante que nos ayude a entender mejor c√≥mo podemos apoyarte..."
              />
              <div className="character-count">
                {formData.message.length}/1000 caracteres
              </div>
            </div>

            <div className="form-actions">
              <Button 
                type="submit" 
                variant="primary" 
                size="large"
                disabled={isSubmitting}
                className={isSubmitting ? 'loading' : ''}
              >
                {isSubmitting ? (
                  <>
                    <FaPaperPlane /> Enviando consulta...
                  </>
                ) : (
                  <>
                    <FaPaperPlane /> Enviar Consulta
                  </>
                )}
              </Button>
              <p className="form-note">
                * Tu consulta ser√° enviada directamente a nuestro equipo de AURA. 
                Nos comprometemos a responder seg√∫n la prioridad indicada y siempre 
                mantendremos la confidencialidad de tu informaci√≥n.
              </p>
            </div>
          </form>
        </div>
      </div>
    </section>
  );
};

export default ContactForm;